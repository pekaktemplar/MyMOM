<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Notulen Rapat - Fullerton Health Clinic Bali</title>
    <!-- Menggunakan Tailwind CSS untuk styling modern dan responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK (Compatibility version for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk mode cetak */
        @media print {
            body { 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            main, #app-container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            .no-print { display: none !important; }
            .print-break-inside-avoid { page-break-inside: avoid; }
            /* Memastikan border terlihat saat dicetak */
            .printable-content {
                border: 1px solid #e2e8f0 !important;
            }
        }
        /* Animasi dan style tambahan */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }

        /* Placeholder untuk contenteditable div */
        [contenteditable="true"]:empty::before {
            content: attr(data-placeholder);
            color: #9ca3af; /* Tailwind's gray-400 */
            pointer-events: none;
            display: block; /* Agar placeholder muncul */
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Container untuk Login -->
    <div id="login-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-sm text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Minutes of Meeting</h1>
            <p class="text-lg text-slate-500 mt-1 mb-8">Fullerton Health Clinic Bali</p>
            <button onclick="signInWithGoogle()" class="w-full bg-white text-slate-700 px-4 py-3 rounded-lg border border-slate-300 hover:bg-slate-100 transition duration-300 font-semibold flex items-center justify-center gap-3">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.565-3.463-11.127-8.169l-6.571,4.819C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C39.902,36.639,44,30.886,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Login dengan Google
            </button>
        </div>
    </div>
    
    <!-- Container untuk Akses Ditolak -->
    <div id="access-denied-container" class="hidden min-h-screen flex flex-col items-center justify-center p-4 text-center">
         <h1 class="text-2xl font-bold text-red-600">Akses Ditolak</h1>
         <p class="text-slate-600 mt-2">Maaf, alamat email Anda tidak terdaftar untuk mengakses aplikasi ini.</p>
         <p id="denied-email" class="text-sm text-slate-500 font-mono my-4"></p>
         <button onclick="signOut()" class="bg-slate-700 text-white px-6 py-2 rounded-lg hover:bg-slate-800 transition">Logout</button>
    </div>

    <!-- Container Utama Aplikasi (hidden by default) -->
    <div id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-6 fade-in">
            <h1 class="text-3xl sm:text-4xl font-bold text-sky-700">Minutes of Meeting</h1>
            <p class="text-lg text-slate-500 mt-1">Fullerton Health Clinic Bali</p>
        </header>
        
        <!-- Info Pengguna dan Logout -->
        <div id="user-info" class="max-w-5xl mx-auto mb-4 flex justify-end items-center gap-3 no-print">
            <span id="user-email" class="text-sm text-slate-600 truncate max-w-[150px] sm:max-w-xs"></span>
            <button onclick="signOut()" class="bg-white text-slate-500 text-xs px-3 py-1 rounded-md border border-slate-300 hover:bg-slate-100 transition flex-shrink-0">Logout</button>
        </div>

        <!-- Menu Aksi Global -->
        <div class="max-w-5xl mx-auto mb-4 flex flex-wrap gap-2 justify-between items-center no-print">
            <div>
                <button onclick="openArchiveModal()" class="bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 transition duration-300 font-semibold text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                    Arsip Rapat
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('import-file').click()" class="bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 transition duration-300 font-semibold text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Impor
                </button>
                <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(event)">
                <button onclick="exportData()" class="bg-white text-slate-700 px-4 py-2 rounded-lg border border-slate-300 hover:bg-slate-100 transition duration-300 font-semibold text-sm flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Ekspor
                </button>
            </div>
        </div>

        <main id="main-content" class="bg-white p-4 sm:p-6 lg:p-8 rounded-2xl shadow-lg max-w-5xl mx-auto">
            
            <!-- Informasi Detail Rapat -->
            <section id="meeting-details" class="border-b pb-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">Detail Rapat</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="meeting-id">
                    <div>
                        <label for="meeting-topic" class="block text-sm font-medium text-slate-600 mb-1">Agenda / Topik Rapat</label>
                        <input type="text" id="meeting-topic" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition" placeholder="Contoh: Evaluasi Kinerja Bulanan">
                    </div>
                    <div>
                        <label for="meeting-date" class="block text-sm font-medium text-slate-600 mb-1">Tanggal & Waktu</label>
                        <input type="datetime-local" id="meeting-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition">
                    </div>
                </div>
            </section>

            <!-- Daftar Kehadiran -->
            <section id="attendance" class="border-b pb-6 mb-6 print-break-inside-avoid">
                 <h2 class="text-xl font-semibold mb-4 text-slate-700">Daftar Kehadiran</h2>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8">
                    <div>
                        <h3 class="font-semibold text-slate-600 mb-2">Tenaga Medis</h3>
                        <div id="medical-staff-list" class="space-y-2"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-slate-600 mb-2 mt-4 sm:mt-0">Staf Operasional</h3>
                        <div id="operational-staff-list" class="space-y-2"></div>
                    </div>
                 </div>
                 <div class="mt-4 flex flex-wrap gap-2 no-print">
                    <input type="text" id="new-attendee-name" placeholder="Nama Peserta Baru" class="flex-grow p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition min-w-[150px]">
                    <select id="new-attendee-role" class="p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition">
                        <option value="medical">Tenaga Medis</option>
                        <option value="operational">Staf Operasional</option>
                    </select>
                    <button onclick="addAttendee()" class="bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition duration-300 font-medium">Tambah</button>
                 </div>
            </section>

            <!-- Catatan Rapat -->
            <section id="notes" class="border-b pb-6 mb-6 print-break-inside-avoid">
                <h2 class="text-xl font-semibold mb-4 text-slate-700">Notulensi / Poin Pembahasan</h2>
                <div id="meeting-notes" contenteditable="true"
                     class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition leading-relaxed min-h-[120px] printable-content"
                     data-placeholder="Tuliskan poin-poin penting hasil diskusi di sini..."
                     onkeydown="handleNotesEnter(event)" onfocus="initNotes(this)" onblur="saveMeetingNotes()">
                </div>
            </section>
            
            <!-- Butir Tindak Lanjut -->
            <section id="action-items" class="print-break-inside-avoid">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-xl font-semibold text-slate-700">Butir Aksi</h2>
                    <div class="flex flex-wrap gap-2 no-print">
                        <select id="filter-owner" onchange="renderActionItems()" class="p-1 border border-slate-300 rounded-md text-sm"><option value="All">Semua PJ</option></select>
                        <select id="filter-status" onchange="renderActionItems()" class="p-1 border border-slate-300 rounded-md text-sm">
                            <option value="All">Semua Status</option>
                            <option value="Issued">Issued</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div id="action-items-list" class="space-y-4 mb-4"></div>
                <div class="bg-slate-50 p-4 rounded-lg no-print">
                    <h3 class="font-semibold text-slate-600 mb-3">Tambah Butir Aksi Baru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="action-item-desc" placeholder="Deskripsi Tugas" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition">
                        <select id="action-item-owner" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition"><option>Pilih Penanggung Jawab...</option></select>
                        <input type="date" id="action-item-due-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 transition" title="Batas Waktu">
                        <button onclick="addActionItem()" class="md:col-span-2 w-full bg-sky-600 text-white px-4 py-2 rounded-lg hover:bg-sky-700 transition font-medium flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            Tambahkan Aksi
                        </button>
                    </div>
                </div>
            </section>

            <!-- Tombol Aksi Utama -->
            <div class="mt-8 pt-6 border-t flex flex-col sm:flex-row justify-end gap-3 no-print">
                <button onclick="startNewMeeting()" class="bg-sky-600 text-white px-6 py-2 rounded-lg hover:bg-sky-700 transition font-semibold flex items-center justify-center gap-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                    Rapat Baru
                </button>
                <button onclick="saveMeeting()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Simpan Notulen
                </button>
                <button onclick="printMeeting()" class="bg-slate-700 text-white px-6 py-2 rounded-lg hover:bg-slate-800 transition font-semibold flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    Cetak / PDF
                </button>
            </div>
        </main>

        <footer class="text-center mt-8 text-slate-400 text-sm">
            <p>&copy; 2024 Dibuat untuk Fullerton Health Clinic Bali</p>
        </footer>
    </div>

    <!-- Modal Arsip Rapat -->
    <div id="archive-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 class="text-xl font-semibold text-slate-700">Arsip Rapat</h2>
                <button onclick="closeArchiveModal()" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </header>
            <div class="p-4 border-b">
                <input type="text" id="search-archive" onkeyup="renderArchiveList()" placeholder="Cari berdasarkan topik atau catatan..." class="w-full p-2 border border-slate-300 rounded-lg">
            </div>
            <div id="archive-list" class="overflow-y-auto p-4 flex-grow">
                <!-- Daftar arsip akan dirender di sini -->
            </div>
        </div>
    </div>
    
    <!-- Notifikasi -->
    <div id="notification" class="hidden fixed top-5 right-5 bg-green-500 text-white py-2 px-5 rounded-lg shadow-xl transition-transform translate-x-full z-50"></div>

    <script>
    // ▼▼▼ 1. TEMPEL KODE FIREBASE CONFIG ANDA DI SINI ▼▼▼
    // Dapatkan kode ini dari Project Settings di Firebase Console Anda
    const firebaseConfig = {
        apiKey: "AIzaSyAyejEiJg2rAqjUMhmsyjKEyUUJa4wdVhg",
        authDomain: "mymom-7f522.firebaseapp.com",
        projectId: "mymom-7f522",
        storageBucket: "mymom-7f522.firebasestorage.app",
        messagingSenderId: "528290589165",
        appId: "1:528290589165:web:17805c40f15fce2fa0dfe4"
    };

    // ▼▼▼ 2. (PENTING) CANTUMKAN ALAMAT EMAIL YANG DIBERIKAN AKSES DI SINI ▼▼▼
    // Hanya email di dalam daftar ini yang bisa mengakses aplikasi setelah login.
    const authorizedEmails = [
        "pekaktemplar@gmail.com",
        "nurse.tmcbali@gmail.com",
        "agusbudiarthalg@gmail.com"
        // Tambahkan email lainnya di sini
    ];
    // ▲▲▲ JANGAN UBAH KODE DI BAWAHNYA ▲▲▲

    let db;
    let auth;
    // ▼▼▼ 3. INISIALISASI FIREBASE (JANGAN DIUBAH) ▼▼▼
    try {
        if (firebaseConfig.apiKey && !firebaseConfig.apiKey.includes("GANTI_DENGAN")) {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log("Firebase successfully initialized.");
        } else {
            console.warn("Firebase config is not set. Login will not work.");
        }
    } catch (e) {
        console.error("Error initializing Firebase:", e);
    }
    // ▲▲▲ END OF FIREBASE INIT ▲▲▲

    // --- MANAJEMEN UI ---
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const accessDeniedContainer = document.getElementById('access-denied-container');

    // --- FUNGSI OTENTIKASI ---
    function signInWithGoogle() {
        if (!auth) {
            alert("Firebase belum dikonfigurasi. Login tidak bisa dilakukan.");
            return;
        }
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            console.error("Login Error:", error);
            alert("Gagal login: " + error.message);
        });
    }

    function signOut() {
        if (auth) {
            auth.signOut();
        }
    }

    // --- PEMERIKSA STATUS LOGIN (ENTRY POINT UTAMA) ---
    function initAuth() {
        if (!auth) {
            // Jika firebase tidak ada, tampilkan login screen saja
            loginContainer.classList.remove('hidden');
            return;
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                // Pengguna sudah login
                if (authorizedEmails.includes(user.email)) {
                    // Email terdaftar, tampilkan aplikasi
                    loginContainer.classList.add('hidden');
                    accessDeniedContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    document.getElementById('user-email').textContent = user.email;
                    initializeApp(); // Mulai aplikasi utama
                } else {
                    // Email tidak terdaftar
                    loginContainer.classList.add('hidden');
                    appContainer.classList.add('hidden');
                    accessDeniedContainer.classList.remove('hidden');
                    document.getElementById('denied-email').textContent = user.email;
                }
            } else {
                // Pengguna belum login
                appContainer.classList.add('hidden');
                accessDeniedContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
            }
        });
    }


    // --- DATABASE ---
    // Mengelola semua data aplikasi
    let appData = {
        attendeeList: {
            medical: [
                "dr. I Gede Tirtayasa, M.Biomed",
                "dr. Luh Gede Puspita Dewi",
                "dr. Komang Triska D.",
                "dr. Putu Candra Wiguna"
            ],
            operational: [
                "Ni Kadek Ayu",
                "Ni Nyoman Tri",
                "I Gusti Agung Diah",
                "A. A. Sagung Istri"
            ]
        },
        meetings: [],
        currentMeeting: null,
    };

    // --- FUNGSI UTAMA ---
    async function saveAllData() {
        if (db) {
            try {
                // Saat menggunakan Firestore, lebih baik menyimpan data dalam format objek JS murni
                const dataToSave = JSON.parse(JSON.stringify(appData));
                await db.collection("mom-data").doc("main").set(dataToSave);
            } catch (e) {
                console.error("Error saving to Firestore:", e, "Saving to local storage as fallback.");
                localStorage.setItem('momAppData', JSON.stringify(appData));
            }
        } else {
            localStorage.setItem('momAppData', JSON.stringify(appData));
        }
    }

    async function loadAllData() {
        if (db) {
            try {
                const docRef = await db.collection("mom-data").doc("main").get();
                if (docRef.exists) {
                    const loadedData = docRef.data();
                    // Pastikan semua properti ada untuk menghindari error
                    appData.attendeeList = loadedData.attendeeList || { medical: [], operational: [] };
                    appData.meetings = loadedData.meetings || [];
                    appData.currentMeeting = loadedData.currentMeeting || null;
                    console.log("Data loaded from Firestore.");
                } else {
                     console.log("No online data found. Starting fresh.");
                }
            } catch (e) {
                console.error("Error loading from Firestore:", e, "Falling back to local storage.");
                const savedData = localStorage.getItem('momAppData');
                if (savedData) appData = JSON.parse(savedData);
            }
        } else {
            const savedData = localStorage.getItem('momAppData');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }
    }

    function loadMeetingIntoView(meeting) {
        if (!meeting) return;

        // Data migration for followUp structure
        if (meeting.actionItems && Array.isArray(meeting.actionItems)) {
            meeting.actionItems.forEach(item => {
                if (typeof item.followUp === 'string') {
                    item.followUp = item.followUp ? [{ date: '', note: item.followUp }] : [];
                } else if (!Array.isArray(item.followUp)) {
                    item.followUp = [];
                }
            });
        }

        appData.currentMeeting = meeting;
        document.getElementById('meeting-id').value = meeting.id;
        document.getElementById('meeting-topic').value = meeting.topic;
        document.getElementById('meeting-date').value = meeting.date;
        document.getElementById('meeting-notes').innerHTML = meeting.notes || '';
        initNotes(document.getElementById('meeting-notes'));
        renderAttendees();
        renderActionItems();
        updateOwnerDropdowns();
    }

    async function startNewMeeting() {
        if (appData.currentMeeting) {
            await saveMeeting(); // Simpan rapat saat ini sebelum membuat yang baru
        }

        const lastMeeting = appData.meetings.length > 0 ? appData.meetings[appData.meetings.length - 1] : null;
        const openActionItems = lastMeeting ? lastMeeting.actionItems.filter(item => item.status !== 'Closed') : [];

        const newMeeting = {
            id: Date.now(),
            topic: '',
            date: new Date().toISOString().slice(0, 16),
            notes: '',
            attendees: JSON.parse(JSON.stringify(appData.attendeeList)), // Salin daftar default
            actionItems: openActionItems.map(item => ({...item, id: Date.now() + Math.random()})) // Bawa item aksi yg belum selesai
        };
        
        // Tandai semua peserta sebagai tidak hadir secara default
        for (const role in newMeeting.attendees) {
            newMeeting.attendees[role] = newMeeting.attendees[role].map(name => ({name, present: false}));
        }

        appData.meetings.push(newMeeting);
        loadMeetingIntoView(newMeeting);
        showNotification('Rapat baru dimulai. Butir aksi yang belum selesai telah dibawa.', 'info');
    }
    
    function saveMeetingNotes() {
        if (!appData.currentMeeting) return;
        appData.currentMeeting.notes = document.getElementById('meeting-notes').innerHTML;
    }

    async function saveMeeting() {
        if (!appData.currentMeeting) return;
        const meetingId = appData.currentMeeting.id;
        
        const meetingIndex = appData.meetings.findIndex(m => m.id === meetingId);
        if (meetingIndex > -1) {
            // Update data dari UI ke object appData.currentMeeting
            appData.currentMeeting.topic = document.getElementById('meeting-topic').value;
            appData.currentMeeting.date = document.getElementById('meeting-date').value;
            saveMeetingNotes(); // Simpan isi dari div
            
            // Salin object yang sudah diupdate ke array meetings utama
            appData.meetings[meetingIndex] = appData.currentMeeting;
            
            await saveAllData();
            showNotification('Notulen berhasil disimpan!');
        }
    }
    
    // --- FUNGSI KEHADIRAN ---
    function renderAttendees() {
        const medicalListEl = document.getElementById('medical-staff-list');
        const operationalListEl = document.getElementById('operational-staff-list');
        medicalListEl.innerHTML = '';
        operationalListEl.innerHTML = '';

        if (!appData.currentMeeting) return;
        
        const currentAttendees = appData.currentMeeting.attendees;

        currentAttendees.medical.forEach(attendee => {
            medicalListEl.innerHTML += `
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 text-slate-700">
                        <input type="checkbox" ${attendee.present ? 'checked' : ''} onchange="toggleAttendance('${attendee.name.replace(/'/g, "\\'")}', 'medical')">
                        ${attendee.name}
                    </label>
                    <button onclick="removeAttendee('${attendee.name.replace(/'/g, "\\'")}', 'medical')" class="text-slate-400 hover:text-red-500 text-xs no-print">&times;</button>
                </div>`;
        });
        
        currentAttendees.operational.forEach(attendee => {
            operationalListEl.innerHTML += `
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 text-slate-700">
                        <input type="checkbox" ${attendee.present ? 'checked' : ''} onchange="toggleAttendance('${attendee.name.replace(/'/g, "\\'")}', 'operational')">
                        ${attendee.name}
                    </label>
                    <button onclick="removeAttendee('${attendee.name.replace(/'/g, "\\'")}', 'operational')" class="text-slate-400 hover:text-red-500 text-xs no-print">&times;</button>
                </div>`;
        });
        
        updateOwnerDropdowns();
    }

    function addAttendee() {
        const nameInput = document.getElementById('new-attendee-name');
        const roleSelect = document.getElementById('new-attendee-role');
        const name = nameInput.value.trim();
        const role = roleSelect.value;
        if (!name) return;

        // Tambahkan ke daftar default untuk rapat berikutnya
        if (!appData.attendeeList[role].includes(name)) {
            appData.attendeeList[role].push(name);
        }

        // Tambahkan ke rapat saat ini
        if (appData.currentMeeting && !appData.currentMeeting.attendees[role].find(p => p.name === name)) {
            appData.currentMeeting.attendees[role].push({ name, present: true });
        }

        nameInput.value = '';
        renderAttendees();
    }

    function removeAttendee(name, role) {
        // Hapus dari daftar default
        appData.attendeeList[role] = appData.attendeeList[role].filter(p => p !== name);
        // Hapus dari rapat saat ini
        if (appData.currentMeeting) {
            appData.currentMeeting.attendees[role] = appData.currentMeeting.attendees[role].filter(p => p.name !== name);
        }
        renderAttendees();
    }

    function toggleAttendance(name, role) {
        if (!appData.currentMeeting) return;
        const person = appData.currentMeeting.attendees[role].find(p => p.name === name);
        if (person) {
            person.present = !person.present;
        }
        updateOwnerDropdowns();
    }

    // --- FUNGSI CATATAN ---
    function handleNotesEnter(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            // Cara modern untuk menyisipkan HTML di posisi kursor
            document.execCommand('insertHTML', false, '<br>•&nbsp;');
        }
    }

    function initNotes(element) {
        if (element.innerHTML.trim() === '' || element.innerHTML.trim() === '<br>') {
            element.innerHTML = '•&nbsp;';
            // Pindahkan kursor setelah bullet point
            const range = document.createRange();
            const sel = window.getSelection();
            range.setStart(element.childNodes[0], 2);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
        }
    }

    // --- FUNGSI BUTIR AKSI ---
    function renderActionItems() {
        const listEl = document.getElementById('action-items-list');
        listEl.innerHTML = '';
        if (!appData.currentMeeting) return;

        const ownerFilter = document.getElementById('filter-owner').value;
        const statusFilter = document.getElementById('filter-status').value;

        const filteredItems = appData.currentMeeting.actionItems.filter(item => {
            const ownerMatch = ownerFilter === 'All' || item.owner === ownerFilter;
            const statusMatch = statusFilter === 'All' || item.status === statusFilter;
            return ownerMatch && statusMatch;
        });

        if (filteredItems.length === 0) {
            listEl.innerHTML = '<p class="text-slate-500 text-center italic">Tidak ada butir aksi yang sesuai filter.</p>';
            return;
        }

        filteredItems.forEach(item => {
            const isClosed = item.status === 'Closed';
            const dueDate = item.dueDate ? new Date(item.dueDate) : null;
            const isOverdue = dueDate && !isClosed && (new Date(dueDate.toDateString()) < new Date(new Date().toDateString()));
            
            let followUpListHtml = '';
            if (item.followUp && Array.isArray(item.followUp) && item.followUp.length > 0) {
                // Urutkan follow up dari yang terbaru
                const sortedFollowUps = [...item.followUp].sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedFollowUps.forEach(fu => {
                    const sanitizedNote = fu.note.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    followUpListHtml += `
                        <div class="text-sm text-slate-700 leading-relaxed">
                            <span class="font-semibold text-slate-800">${fu.date ? new Date(fu.date + 'T00:00:00').toLocaleDateString('id-ID', {day: 'numeric', month: 'short', year: 'numeric'}) : 'Tanpa Tanggal'}</span>:
                            <span class="ml-1">${sanitizedNote}</span>
                        </div>
                    `;
                });
            } else {
                followUpListHtml = '<p class="text-xs text-slate-400 italic no-print">Belum ada follow up.</p>';
            }

            listEl.innerHTML += `
                <div class="border rounded-lg p-4 ${isClosed ? 'bg-slate-100 text-slate-500' : 'bg-white'} print-break-inside-avoid">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-2">
                        <p class="flex-grow ${isClosed ? 'line-through' : ''}">${item.description}</p>
                        <div class="flex items-center gap-3 text-sm flex-shrink-0">
                            <span class="font-medium">${item.owner || 'N/A'}</span>
                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold
                                ${item.status === 'Issued' ? 'bg-yellow-100 text-yellow-800' : ''}
                                ${item.status === 'In Progress' ? 'bg-blue-100 text-blue-800' : ''}
                                ${item.status === 'Closed' ? 'bg-green-100 text-green-800' : ''}
                            ">${item.status}</span>
                            <span class="${isOverdue ? 'text-red-500 font-semibold' : 'text-slate-500'}">${item.dueDate || ''}</span>
                        </div>
                    </div>
                    
                    <div class="mt-3 pl-4 border-l-2 border-slate-200 space-y-2">
                        ${followUpListHtml}
                    </div>

                    ${!isClosed ? `
                    <div class="mt-3 pl-4 no-print">
                        <div class="flex flex-wrap gap-2 items-center">
                            <input type="date" id="followup-date-${item.id}" class="p-1 border rounded-md text-sm w-full sm:w-36">
                            <input type="text" id="followup-note-${item.id}" placeholder="Tambah catatan follow up..." class="flex-grow p-1 border rounded-md text-sm w-full sm:flex-1 min-w-0">
                            <button onclick="addFollowUp(${item.id})" class="bg-sky-600 text-white px-3 py-1 rounded-md text-sm hover:bg-sky-700 font-semibold flex-shrink-0">Tambah</button>
                        </div>
                    </div>
                    ` : ''}

                    <div class="flex gap-2 mt-3 no-print">
                        <select onchange="updateActionItem(${item.id}, 'status', this.value)" class="p-1 border rounded-md text-sm">
                            <option value="Issued" ${item.status === 'Issued' ? 'selected' : ''}>Issued</option>
                            <option value="In Progress" ${item.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Closed" ${item.status === 'Closed' ? 'selected' : ''}>Closed</option>
                        </select>
                        <button onclick="removeActionItem(${item.id})" class="text-slate-400 hover:text-red-500 text-xs">Hapus</button>
                    </div>
                </div>
            `;
        });
    }

    function addFollowUp(itemId) {
        if (!appData.currentMeeting) return;
        const item = appData.currentMeeting.actionItems.find(i => i.id === itemId);
        if (item) {
            const dateInput = document.getElementById(`followup-date-${itemId}`);
            const noteInput = document.getElementById(`followup-note-${itemId}`);
            
            const note = noteInput.value.trim();
            if (!note) {
                alert('Catatan follow up tidak boleh kosong.');
                return;
            }

            const date = dateInput.value || new Date().toISOString().split('T')[0];

            if (!Array.isArray(item.followUp)) {
                item.followUp = [];
            }

            item.followUp.push({ date, note });
            renderActionItems();
        }
    }

    function addActionItem() {
        const descInput = document.getElementById('action-item-desc');
        const ownerSelect = document.getElementById('action-item-owner');
        const dueDateInput = document.getElementById('action-item-due-date');

        if (!descInput.value.trim() || !appData.currentMeeting) return;

        const newItem = {
            id: Date.now(),
            description: descInput.value.trim(),
            owner: ownerSelect.value,
            dueDate: dueDateInput.value,
            status: 'Issued',
            followUp: [] // Selalu mulai dengan array kosong
        };
        appData.currentMeeting.actionItems.push(newItem);
        renderActionItems();

        descInput.value = '';
        ownerSelect.selectedIndex = 0;
        dueDateInput.value = '';
    }

    function updateActionItem(itemId, field, value) {
        if (!appData.currentMeeting) return;
        const item = appData.currentMeeting.actionItems.find(i => i.id === itemId);
        if (item) {
            item[field] = value;
            if (field === 'status') {
                renderActionItems(); // Re-render hanya jika status berubah untuk update UI
            }
        }
    }

    function removeActionItem(itemId) {
        if (!appData.currentMeeting) return;
        appData.currentMeeting.actionItems = appData.currentMeeting.actionItems.filter(i => i.id !== itemId);
        renderActionItems();
    }

    function updateOwnerDropdowns() {
        const ownerSelect = document.getElementById('action-item-owner');
        const filterSelect = document.getElementById('filter-owner');
        
        // Simpan nilai yang sedang dipilih
        const currentOwnerVal = ownerSelect.value;
        const currentFilterVal = filterSelect.value;
        
        ownerSelect.innerHTML = '<option value="">Pilih Penanggung Jawab...</option>';
        filterSelect.innerHTML = '<option value="All">Semua PJ</option>';

        if (!appData.currentMeeting) return;
        
        const presentAttendees = [];
        for (const role in appData.currentMeeting.attendees) {
            appData.currentMeeting.attendees[role].forEach(p => {
                if (p.present) presentAttendees.push(p.name);
            });
        }
        
        presentAttendees.sort().forEach(name => {
            ownerSelect.innerHTML += `<option value="${name}">${name}</option>`;
            filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });

        // Kembalikan nilai yang dipilih jika masih ada di daftar
        ownerSelect.value = currentOwnerVal;
        filterSelect.value = currentFilterVal;
    }

    // --- FUNGSI CETAK ---
    function printMeeting() {
        window.print();
    }

    // --- FUNGSI ARSIP (MODAL) ---
    function openArchiveModal() {
        renderArchiveList();
        document.getElementById('archive-modal').classList.remove('hidden');
    }

    function closeArchiveModal() {
        document.getElementById('archive-modal').classList.add('hidden');
    }

    function renderArchiveList() {
        const listEl = document.getElementById('archive-list');
        const searchTerm = document.getElementById('search-archive').value.toLowerCase();
        listEl.innerHTML = '';
        
        const filteredMeetings = appData.meetings.filter(m => 
            (m.topic && m.topic.toLowerCase().includes(searchTerm)) || 
            (m.notes && m.notes.toLowerCase().includes(searchTerm))
        ).sort((a, b) => new Date(b.date) - new Date(a.date)); // Urutkan dari terbaru

        if (filteredMeetings.length === 0) {
            listEl.innerHTML = '<p class="text-slate-500 text-center">Tidak ada rapat yang ditemukan.</p>';
            return;
        }

        filteredMeetings.forEach(m => {
            listEl.innerHTML += `
                <div class="flex justify-between items-center p-3 border-b hover:bg-slate-50 group">
                    <div class="cursor-pointer flex-grow" onclick="loadMeetingFromArchive(${m.id})">
                        <p class="font-semibold text-slate-800 group-hover:text-sky-700">${m.topic || 'Rapat Tanpa Topik'}</p>
                        <p class="text-sm text-slate-500">${new Date(m.date).toLocaleString('id-ID')}</p>
                    </div>
                    <button onclick="deleteMeeting(${m.id})" class="text-slate-400 hover:text-red-600 font-bold text-lg px-2 rounded-md transition-colors duration-200">
                        &times;
                    </button>
                </div>`;
        });
    }

    async function deleteMeeting(meetingId) {
        if (!confirm('Apakah Anda yakin ingin menghapus notulen ini? Aksi ini tidak bisa dibatalkan.')) {
            return;
        }
        const meetingIndex = appData.meetings.findIndex(m => m.id === meetingId);
        
        if (meetingIndex > -1) {
            appData.meetings.splice(meetingIndex, 1);

            // Jika yang dihapus adalah notulen yang sedang dibuka, muat notulen terbaru
            if (appData.currentMeeting && appData.currentMeeting.id === meetingId) {
                if (appData.meetings.length > 0) {
                    const latestMeeting = appData.meetings.sort((a,b) => b.id - a.id)[0];
                    loadMeetingIntoView(latestMeeting);
                } else {
                    // Jika tidak ada notulen tersisa, mulai yang baru
                    await startNewMeeting();
                }
            }
            
            await saveAllData();
            renderArchiveList(); // Perbarui daftar di arsip
            showNotification('Notulen berhasil dihapus.', 'success');
        }
    }
    
    async function loadMeetingFromArchive(meetingId) {
        if (appData.currentMeeting) {
            await saveMeeting(); // Simpan pekerjaan saat ini sebelum beralih
        }
        const meeting = appData.meetings.find(m => m.id === meetingId);
        if (meeting) {
            loadMeetingIntoView(meeting);
        }
        closeArchiveModal();
    }

    // --- FUNGSI UTILITAS ---
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = 'fixed top-5 right-5 text-white py-2 px-5 rounded-lg shadow-xl transition-transform z-50'; // Reset class
        if (type === 'success') {
            notification.classList.add('bg-green-500');
        } else {
            notification.classList.add('bg-sky-500');
        }
        notification.classList.remove('hidden', 'translate-x-full');
        notification.classList.add('translate-x-0');

        setTimeout(() => {
            notification.classList.remove('translate-x-0');
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.classList.add('hidden'), 300);
        }, 3000);
    }

    // --- FUNGSI EKSPOR / IMPOR ---
    async function exportData() {
        await saveMeeting(); // Pastikan data terbaru ikut tersimpan
        const dataStr = JSON.stringify(appData, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `mom_backup_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        URL.revokeObjectURL(url);
    }
    
    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                // Validasi sederhana
                if (importedData.meetings && importedData.attendeeList) {
                    appData = importedData;
                    // Muat rapat terakhir dari data yang diimpor
                    const lastMeeting = appData.meetings.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                    loadMeetingIntoView(lastMeeting);
                    saveAllData(); // Simpan data yg diimpor
                    showNotification('Data berhasil diimpor!');
                } else {
                    alert('File JSON tidak valid.');
                }
            } catch (error) {
                alert('Gagal membaca file. Pastikan format JSON benar.');
            }
        };
        reader.readAsText(file);
    }
    
    // --- INISIALISASI APLIKASI UTAMA (SETELAH LOGIN) ---
    async function initializeApp() {
        await loadAllData();
        if (appData.meetings.length === 0) {
            // Jika benar-benar baru, buat rapat pertama
            startNewMeeting();
        } else {
            // Muat rapat terakhir yang sedang aktif atau yang paling baru
            const meetingToLoad = appData.currentMeeting || appData.meetings.sort((a,b) => b.id - a.id)[0];
            loadMeetingIntoView(meetingToLoad);
        }
    }

    document.addEventListener('DOMContentLoaded', initAuth);
    </script>
</body>
</html>

